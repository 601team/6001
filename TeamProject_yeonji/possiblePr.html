<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <title>SearchConsult</title>
</head>
<body>
    <div style="position: absolute; z-index: 2; right: 50px;">
        <input class="right" type="submit" id='logOut' name="logOut" value="logOut" />
    </div>
    <div style="padding: 50px;"><h1>교수검색</h1></div>

    <div class="col">
      <table class="table table-striped" id='proTable'>
          <tbody>
              <tr>
                  <td>교수명</td>
                  <td>전공</td>
                  <td>연구실</td>
                  <td>이메일</td>
              </tr>
          </tbody>
      </table>
    </div>
    

    <div class="col">
    <table class="table table-striped" id='ConTimeTable'>
            <tbody>
              <tr>
                <td>상담 가능 요일</td>  
                <td>상담 가능 시간</td>
                <td>예약하기</td>
              </tr>
          </tbody>
      </table>

    
      
    </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
    

    </body>
    
   
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-analytics.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-auth.js"
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAVjfBhilux_3BIyx486cRR2dsybsseKA8",
            authDomain: "team-a5651.firebaseapp.com",
            databaseURL: "https://team-a5651-default-rtdb.firebaseio.com",
            projectId: "team-a5651",
            storageBucket: "team-a5651.appspot.com",
            messagingSenderId: "804446190852",
            appId: "1:804446190852:web:66473b851c3cfc1792e451"
        };
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const dbRef = ref(database,'consultcheck/');
        const auth = getAuth();

        
        $(document).ready(function() {
            $(".btCheck").on('click',function() { 
                var str = ""
                var tdArr = new Array();   // 배열 선언
                var checkBtn = $(this);
                
                // checkBtn.parent() : checkBtn의 부모는 <td>이다.
                // checkBtn.parent().parent() : <td>의 부모이므로 <tr>이다.
                var tr = checkBtn.parent().parent();
                var td = tr.children();
                
                console.log("클릭한 Row의 모든 데이터 : "+tr.text());
                
                var cDate = td.eq(0).text();
                var cTime = td.eq(1).text();
                
                
                // 반복문을 이용해서 배열에 값을 담아 사용할 수 도 있다.
                td.each(function(i){   
                    tdArr.push(td.eq(i).text());
                });
                
                console.log("배열에 담긴 값 : "+tdArr);
                
                str +=   " * 클릭된 Row의 td값 = No. : <font color='red'>" + cDate + "</font>" +
                        ", 아이디 : <font color='red'>" + cTime + "</font>";   
                
                
                //console.log(pm1);
                //console.log(pm);
                // console.log(cDate.substr(cDate.length-2, cDate.length));
                
                var pm=sessionStorage.getItem('proemail');
                var pm1=pm.split("@")[0]; //교수 아이디
                var pd=cDate.substr(cDate.length-2, cDate.length);
                var primary = pm1+pd+cTime;
                var checknum=0;
                //데이터베이스에 저장되어 있는지 확인
                onValue(dbRef,(snapshot)=>{
                    snapshot.forEach((childSnapshot)=>{
                        const childKey = childSnapshot.key;
                        const childData = childSnapshot.val();

                        if (childKey==primary){
                            checknum+=1;
                        }
                    });
                },)
                if (checknum==0){
                    set(ref(database, 'consultcheck/' +primary),{//학생 이메일
                        stumail : sessionStorage.getItem('usermail'),
                        promail : sessionStorage.getItem('proemail'),
                        date : cDate,
                        time : cTime,
                        state : "보류"
                    })
                    alert("저장됨")
                }else{
                    alert("이미 예약된 시간입니다.")
                }
            });
        });

        logOut.addEventListener('click',(e)=>{
            signOut(auth).then(() => {
            // Sign-out successful.
            alert('user loged out');
            sessionStorage.clear();
            location.href='StudentLogin.html'
            }).catch((error) => {
                // An error happened.
                const errorCode = error.code;
                const errorMessage = error.message;
                
                //location.href='StudentLogin.html'
                alert(errorMessage);
            });

        });



        
        
        

    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="searchPr.js"></script>

</html>